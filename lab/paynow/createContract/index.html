
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
        <link rel="canonical" href="https://ibm-wsc.github.io/ConfidentialComputingOnLinuxONE/lab/paynow/createContract/">
      
      
        <link rel="prev" href="../configureRsyslogForHPVS/">
      
      
        <link rel="next" href="../launchHPVSguest/">
      
      <link rel="icon" href="../../../images/HPVS2.1.xGraphic.png">
      <meta name="generator" content="mkdocs-1.4.3, mkdocs-material-9.1.11">
    
    
      
        <title>Create contract for HPVS guest - Confidential Computing LinuxONE Workshop</title>
      
    
    
      <link rel="stylesheet" href="../../../assets/stylesheets/main.85bb2934.min.css">
      
        
        <link rel="stylesheet" href="../../../assets/stylesheets/palette.a6bdf11c.min.css">
      
      

    
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../../../css/print-site-enum-headings1.css">
    
      <link rel="stylesheet" href="../../../css/print-site-enum-headings2.css">
    
      <link rel="stylesheet" href="../../../css/print-site-enum-headings3.css">
    
      <link rel="stylesheet" href="../../../css/print-site-enum-headings4.css">
    
      <link rel="stylesheet" href="../../../css/print-site-enum-headings5.css">
    
      <link rel="stylesheet" href="../../../css/print-site-enum-headings6.css">
    
      <link rel="stylesheet" href="../../../css/print-site.css">
    
      <link rel="stylesheet" href="../../../css/print-site-material.css">
    
    <script>__md_scope=new URL("../../..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      
  


  
  


  <script id="__analytics">function __md_analytics(){function n(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],n("js",new Date),n("config","G-GYNTJ48K9Y"),document.addEventListener("DOMContentLoaded",function(){document.forms.search&&document.forms.search.query.addEventListener("blur",function(){this.value&&n("event","search",{search_term:this.value})}),document$.subscribe(function(){var a=document.forms.feedback;if(void 0!==a)for(var e of a.querySelectorAll("[type=submit]"))e.addEventListener("click",function(e){e.preventDefault();var t=document.location.pathname,e=this.getAttribute("data-md-value");n("event","feedback",{page:t,data:e}),a.firstElementChild.disabled=!0;e=a.querySelector(".md-feedback__note [data-md-value='"+e+"']");e&&(e.hidden=!1)}),a.hidden=!1}),location$.subscribe(function(e){n("config","G-GYNTJ48K9Y",{page_path:e.pathname})})});var e=document.createElement("script");e.async=!0,e.src="https://www.googletagmanager.com/gtag/js?id=G-GYNTJ48K9Y",document.getElementById("__analytics").insertAdjacentElement("afterEnd",e)}</script>

  
    <script>var consent;"undefined"==typeof __md_analytics||(consent=__md_get("__consent"))&&consent.analytics&&__md_analytics()</script>
  

    
    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="slate" data-md-color-primary="black" data-md-color-accent="yellow">
  
    
    
      <script>var palette=__md_get("__palette");if(palette&&"object"==typeof palette.color)for(var key of Object.keys(palette.color))document.body.setAttribute("data-md-color-"+key,palette.color[key])</script>
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#create-contract-for-hpvs-guest" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow md-header--lifted" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../../.." title="Confidential Computing LinuxONE Workshop" class="md-header__button md-logo" aria-label="Confidential Computing LinuxONE Workshop" data-md-component="logo">
      
  <img src="../../../images/HPVS2.1.xGraphic.png" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Confidential Computing LinuxONE Workshop
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Create contract for HPVS guest
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
          
            
            
            
            <input class="md-option" data-md-color-media="(prefers-color-scheme: dark)" data-md-color-scheme="slate" data-md-color-primary="black" data-md-color-accent="yellow"  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_1">
            
              <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_2" hidden>
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 18c-.89 0-1.74-.2-2.5-.55C11.56 16.5 13 14.42 13 12c0-2.42-1.44-4.5-3.5-5.45C10.26 6.2 11.11 6 12 6a6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12 20 8.69Z"/></svg>
              </label>
            
          
            
            
            
            <input class="md-option" data-md-color-media="(prefers-color-scheme: light)" data-md-color-scheme="default" data-md-color-primary="black" data-md-color-accent="yellow"  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_2">
            
              <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_1" hidden>
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a4 4 0 0 0-4 4 4 4 0 0 0 4 4 4 4 0 0 0 4-4 4 4 0 0 0-4-4m0 10a6 6 0 0 1-6-6 6 6 0 0 1 6-6 6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12 20 8.69Z"/></svg>
              </label>
            
          
        </form>
      
    
    
    
      <label class="md-header__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
          <a href="javascript:void(0)" class="md-search__icon md-icon" title="Share" aria-label="Share" data-clipboard data-clipboard-text="" data-md-component="search-share" tabindex="-1">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7c.05-.23.09-.46.09-.7 0-.24-.04-.47-.09-.7l7.05-4.11c.54.5 1.25.81 2.04.81a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3c0 .24.04.47.09.7L8.04 9.81C7.5 9.31 6.79 9 6 9a3 3 0 0 0-3 3 3 3 0 0 0 3 3c.79 0 1.5-.31 2.04-.81l7.12 4.15c-.05.21-.08.43-.08.66 0 1.61 1.31 2.91 2.92 2.91 1.61 0 2.92-1.3 2.92-2.91A2.92 2.92 0 0 0 18 16.08Z"/></svg>
          </a>
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        <a href="https://github.com/ibm-wsc/ConfidentialComputingOnLinuxONE" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.4.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
      </div>
    
  </nav>
  
    
      
<nav class="md-tabs" aria-label="Tabs" data-md-component="tabs">
  <div class="md-grid">
    <ul class="md-tabs__list">
      
        
  
  


  <li class="md-tabs__item">
    <a href="../../.." class="md-tabs__link">
      Home
    </a>
  </li>

      
        
  
  


  <li class="md-tabs__item">
    <a href="../../../access/" class="md-tabs__link">
      Lab Access
    </a>
  </li>

      
        
  
  
    
  


  
  
  
    <li class="md-tabs__item">
      <a href="../" class="md-tabs__link md-tabs__link--active">
        PayNow Lab
      </a>
    </li>
  

      
        
  
  


  
  
  
    <li class="md-tabs__item">
      <a href="../../grep11/" class="md-tabs__link">
        GREP11 with CENA4SEE Lab
      </a>
    </li>
  

      
        
  
  


  
  
  
    <li class="md-tabs__item">
      <a href="../../cloud/" class="md-tabs__link">
        IBM Cloud-based labs
      </a>
    </li>
  

      
        
  
  


  <li class="md-tabs__item">
    <a href="../../../localdocbuild/" class="md-tabs__link">
      Locally Building docs
    </a>
  </li>

      
        
  
  


  <li class="md-tabs__item">
    <a href="../../../print_page/" class="md-tabs__link">
      Print Site
    </a>
  </li>

      
    </ul>
  </div>
</nav>
    
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

  


<nav class="md-nav md-nav--primary md-nav--lifted" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../../.." title="Confidential Computing LinuxONE Workshop" class="md-nav__button md-logo" aria-label="Confidential Computing LinuxONE Workshop" data-md-component="logo">
      
  <img src="../../../images/HPVS2.1.xGraphic.png" alt="logo">

    </a>
    Confidential Computing LinuxONE Workshop
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/ibm-wsc/ConfidentialComputingOnLinuxONE" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.4.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../.." class="md-nav__link">
        Home
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../../access/" class="md-nav__link">
        Lab Access
      </a>
    </li>
  

    
      
      
      

  
  
    
  
  
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3" checked>
      
      
        
          
            
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
      
      
        
        
        <div class="md-nav__link md-nav__link--index ">
          <a href="../">PayNow Lab</a>
          
            <label for="__nav_3">
              <span class="md-nav__icon md-icon"></span>
            </label>
          
        </div>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="true">
        <label class="md-nav__title" for="__nav_3">
          <span class="md-nav__icon md-icon"></span>
          PayNow Lab
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../launchKVMguest/" class="md-nav__link">
        Launch Ubuntu KVM guest
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../downloadPayNowRepo/" class="md-nav__link">
        Download PayNow GitHub repo
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../createOCIimage/" class="md-nav__link">
        Create OCI image
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../runOCIimage/" class="md-nav__link">
        Run OCI image
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../useWebApp/" class="md-nav__link">
        Use the PayNow demo app
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../findSensitiveData/" class="md-nav__link">
        Find sensitive data in core dump
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../configureRsyslog/" class="md-nav__link">
        Configure rsyslog on your KVM guest
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../configureRsyslogForHPVS/" class="md-nav__link">
        Configure rsyslog client certs on the RHEL host
      </a>
    </li>
  

            
          
            
              
  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          Create contract for HPVS guest
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        Create contract for HPVS guest
      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#overview-of-this-section" class="md-nav__link">
    Overview of this section
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#creation-of-directory-structure-for-contract" class="md-nav__link">
    Creation of directory structure for contract
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#create-workload-section-of-the-contract" class="md-nav__link">
    Create workload section of the contract
  </a>
  
    <nav class="md-nav" aria-label="Create workload section of the contract">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#create-docker-compose-file" class="md-nav__link">
    Create docker-compose file
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#add-a-convenience-script-to-create-the-workload-section" class="md-nav__link">
    Add a convenience script to create the workload section
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#create-environment-section-of-the-contract" class="md-nav__link">
    Create environment section of the contract
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#encrypt-and-sign-the-contract" class="md-nav__link">
    Encrypt and sign the contract
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#create-the-startup-file-for-the-hpvs-kvm-guest" class="md-nav__link">
    Create the startup file for the HPVS KVM guest
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../launchHPVSguest/" class="md-nav__link">
        Launch HPVS guest for PayNow
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../useHPVSWebApp/" class="md-nav__link">
        Use the HPVS-based PayNow demo app
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../tryToFindSensitiveData/" class="md-nav__link">
        Try to find sensitive data in core dump
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../labCleanup/" class="md-nav__link">
        Lab Cleanup
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
        
      
      <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_4" >
      
      
        
          
            
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
      
      
        
        
        <div class="md-nav__link md-nav__link--index ">
          <a href="../../grep11/">GREP11 with CENA4SEE Lab</a>
          
            <label for="__nav_4">
              <span class="md-nav__icon md-icon"></span>
            </label>
          
        </div>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_4_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_4">
          <span class="md-nav__icon md-icon"></span>
          GREP11 with CENA4SEE Lab
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../grep11/launchKVMguest/" class="md-nav__link">
        Launch Ubuntu KVM guest
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../grep11/configureRsyslog/" class="md-nav__link">
        Configure rsyslog on your KVM guest
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../grep11/configureRsyslogForGREP11/" class="md-nav__link">
        Configure rsyslog client certs on the RHEL host
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../grep11/createGREP11Contract/" class="md-nav__link">
        Create Contract for GREP11 Server
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../grep11/launchGREP11guest/" class="md-nav__link">
        Launch GREP11 Server
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../grep11/configureGrep11TestClient/" class="md-nav__link">
        Run GREP11 Client code
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../grep11/hackMeIfYouCan/" class="md-nav__link">
        Standard guest vs. SE-enabled HPVS 2.1.x guest
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../grep11/labCleanup/" class="md-nav__link">
        Lab Cleanup
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
        
      
      <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_5" >
      
      
        
          
            
          
        
          
        
          
        
          
        
          
        
          
        
          
        
      
      
        
        
        <div class="md-nav__link md-nav__link--index ">
          <a href="../../cloud/">IBM Cloud-based labs</a>
          
            <label for="__nav_5">
              <span class="md-nav__icon md-icon"></span>
            </label>
          
        </div>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_5_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_5">
          <span class="md-nav__icon md-icon"></span>
          IBM Cloud-based labs
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
          
            
              
  
  
  
    
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
      
      
      
        
      
      <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_5_2" >
      
      
        
          
            
          
        
          
        
          
        
          
        
          
        
          
        
          
        
      
      
        
        
        <div class="md-nav__link md-nav__link--index ">
          <a href="../../cloud/prereqs/">Overview and Prerequisites</a>
          
            <label for="__nav_5_2">
              <span class="md-nav__icon md-icon"></span>
            </label>
          
        </div>
      
      <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_5_2_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_5_2">
          <span class="md-nav__icon md-icon"></span>
          Overview and Prerequisites
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../cloud/prereqs/vpc/" class="md-nav__link">
        Create a Virtual Private Cloud
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../cloud/prereqs/gateway/" class="md-nav__link">
        Create a Public Gateway
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../cloud/prereqs/ibmlog/" class="md-nav__link">
        Create an IBM Log Analysis instance
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../cloud/prereqs/prepsystem/" class="md-nav__link">
        Establish a "prep system" to use to create contracts
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../cloud/prereqs/setup/" class="md-nav__link">
        Set environment variables for lab portability
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../cloud/prereqs/setup2/" class="md-nav__link">
        Set environment variables for contract preparation
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
      
      
      
        
      
      <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_5_3" >
      
      
        
          
            
          
        
          
        
          
        
      
      
        
        
        <div class="md-nav__link md-nav__link--index ">
          <a href="../../cloud/lab1/">Lab 1 - simple plaintext contract</a>
          
            <label for="__nav_5_3">
              <span class="md-nav__icon md-icon"></span>
            </label>
          
        </div>
      
      <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_5_3_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_5_3">
          <span class="md-nav__icon md-icon"></span>
          Lab 1 - simple plaintext contract
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../cloud/lab1/prepcontract/" class="md-nav__link">
        Prepare the contract
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../cloud/lab1/createinstance/" class="md-nav__link">
        Create your Hyper Protect Virtual Servers for IBM Cloud VPC instance
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
      
      
      
        
      
      <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_5_4" >
      
      
        
          
            
          
        
          
        
          
        
      
      
        
        
        <div class="md-nav__link md-nav__link--index ">
          <a href="../../cloud/lab2/">Lab 2 - partially encrypted contract</a>
          
            <label for="__nav_5_4">
              <span class="md-nav__icon md-icon"></span>
            </label>
          
        </div>
      
      <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_5_4_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_5_4">
          <span class="md-nav__icon md-icon"></span>
          Lab 2 - partially encrypted contract
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../cloud/lab2/prepcontract/" class="md-nav__link">
        Prepare the contract
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../cloud/lab2/createinstance/" class="md-nav__link">
        Create your Hyper Protect Virtual Servers for IBM Cloud VPC instance
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
      
      
      
        
      
      <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_5_5" >
      
      
        
          
            
          
        
          
        
          
        
      
      
        
        
        <div class="md-nav__link md-nav__link--index ">
          <a href="../../cloud/lab3/">Lab 3 - encrypted contract</a>
          
            <label for="__nav_5_5">
              <span class="md-nav__icon md-icon"></span>
            </label>
          
        </div>
      
      <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_5_5_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_5_5">
          <span class="md-nav__icon md-icon"></span>
          Lab 3 - encrypted contract
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../cloud/lab3/prepcontract/" class="md-nav__link">
        Prepare the contract
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../cloud/lab3/createinstance/" class="md-nav__link">
        Create your Hyper Protect Virtual Servers for IBM Cloud VPC instance
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
      
      
      
        
      
      <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_5_6" >
      
      
        
          
            
          
        
          
        
          
        
      
      
        
        
        <div class="md-nav__link md-nav__link--index ">
          <a href="../../cloud/lab4/">Lab 4 - encrypted and signed contract</a>
          
            <label for="__nav_5_6">
              <span class="md-nav__icon md-icon"></span>
            </label>
          
        </div>
      
      <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_5_6_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_5_6">
          <span class="md-nav__icon md-icon"></span>
          Lab 4 - encrypted and signed contract
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../cloud/lab4/prepcontract/" class="md-nav__link">
        Prepare the contract
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../cloud/lab4/createinstance/" class="md-nav__link">
        Create your Hyper Protect Virtual Servers for IBM Cloud VPC instance
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../cloud/cleanup/cleanup/" class="md-nav__link">
        IBM Cloud-based labs cleanup
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../../localdocbuild/" class="md-nav__link">
        Locally Building docs
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../../print_page/" class="md-nav__link">
        Print Site
      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#overview-of-this-section" class="md-nav__link">
    Overview of this section
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#creation-of-directory-structure-for-contract" class="md-nav__link">
    Creation of directory structure for contract
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#create-workload-section-of-the-contract" class="md-nav__link">
    Create workload section of the contract
  </a>
  
    <nav class="md-nav" aria-label="Create workload section of the contract">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#create-docker-compose-file" class="md-nav__link">
    Create docker-compose file
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#add-a-convenience-script-to-create-the-workload-section" class="md-nav__link">
    Add a convenience script to create the workload section
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#create-environment-section-of-the-contract" class="md-nav__link">
    Create environment section of the contract
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#encrypt-and-sign-the-contract" class="md-nav__link">
    Encrypt and sign the contract
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#create-the-startup-file-for-the-hpvs-kvm-guest" class="md-nav__link">
    Create the startup file for the HPVS KVM guest
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  

  
    <a href="https://github.com/ibm-wsc/ConfidentialComputingOnLinuxONE/edit/main/docs/lab/paynow/createContract.md" title="Edit this page" class="md-content__button md-icon">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M10 20H6V4h7v5h5v3.1l2-2V8l-6-6H6c-1.1 0-2 .9-2 2v16c0 1.1.9 2 2 2h4v-2m10.2-7c.1 0 .3.1.4.2l1.3 1.3c.2.2.2.6 0 .8l-1 1-2.1-2.1 1-1c.1-.1.2-.2.4-.2m0 3.9L14.1 23H12v-2.1l6.1-6.1 2.1 2.1Z"/></svg>
    </a>
  
  
    
      
    
    <a href="https://github.com/ibm-wsc/ConfidentialComputingOnLinuxONE/raw/main/docs/lab/paynow/createContract.md" title="View source of this page" class="md-content__button md-icon">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M17 18c.56 0 1 .44 1 1s-.44 1-1 1-1-.44-1-1 .44-1 1-1m0-3c-2.73 0-5.06 1.66-6 4 .94 2.34 3.27 4 6 4s5.06-1.66 6-4c-.94-2.34-3.27-4-6-4m0 6.5a2.5 2.5 0 0 1-2.5-2.5 2.5 2.5 0 0 1 2.5-2.5 2.5 2.5 0 0 1 2.5 2.5 2.5 2.5 0 0 1-2.5 2.5M9.27 20H6V4h7v5h5v4.07c.7.08 1.36.25 2 .49V8l-6-6H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h4.5a8.15 8.15 0 0 1-1.23-2Z"/></svg>
    </a>
  


<h1 id="create-contract-for-hpvs-guest">Create contract for HPVS guest<a class="headerlink" href="#create-contract-for-hpvs-guest" title="Permanent link">&para;</a></h1>
<h2 id="overview-of-this-section">Overview of this section<a class="headerlink" href="#overview-of-this-section" title="Permanent link">&para;</a></h2>
<p>IBM provides the <abbr title="IBMÂ® Secure Execution for LinuxÂ® is a z/ArchitectureÂ® security technology that is introduced with IBM z15â„¢ and LinuxONE III. It protects data of workloads that run in a KVM guest from being inspected or modified by the server environment. In particular, no hardware administrator, no KVM code, and no KVM administrator can access the data in a guest that was started as an IBM Secure Execution guest.">Secure Execution</abbr> feature on z15 and newer generations of its IBM zSystems and LinuxONE servers.  Currently, that's z15 and LinuxONE III for the "z15" generation and z16 and LinuxONE Emperor 4 for the "z16" generation.</p>
<p>You could create your own <abbr title="IBMÂ® Secure Execution for LinuxÂ® is a z/ArchitectureÂ® security technology that is introduced with IBM z15â„¢ and LinuxONE III. It protects data of workloads that run in a KVM guest from being inspected or modified by the server environment. In particular, no hardware administrator, no KVM code, and no KVM administrator can access the data in a guest that was started as an IBM Secure Execution guest.">Secure Execution</abbr>-enabled KVM guests and run a workload in it without Hyper Protect Virtual Servers 2.1.4.  However, there's non-trivial work involved in setting this up.  HPVS 2.1.4 has done that hard work for you, and provided a KVM guest image that will run your application workload as an <abbr title="Open Container Initiative: an open governance structure for the express purpose of creating open industry standards around container formats and runtimes. There are 3 specifications: the Runtime Specification (runtime-spec), the Image Specification (image-spec) and the Distribution Specification (distribution-spec)">OCI</abbr>-compliant (again, think "Docker" in the popular vernacular) <abbr title="a running instance of an OCI image.">container</abbr> within the HPVS 2.1.4 KVM guest.  There is still some work involved in setting up the contract that HPVS 2.1.4 expects- but this is work closer to the <em>application</em> or <em>business</em> level. There is also added value in HPVS 2.1.4 in areas such as:</p>
<ul class="task-list">
<li class="task-list-item"><label class="task-list-control"><input type="checkbox" disabled checked/><span class="task-list-indicator"></span></label> logging</li>
<li class="task-list-item"><label class="task-list-control"><input type="checkbox" disabled/><span class="task-list-indicator"></span></label> attestation</li>
<li class="task-list-item"><label class="task-list-control"><input type="checkbox" disabled checked/><span class="task-list-indicator"></span></label> verification during boot</li>
<li class="task-list-item"><label class="task-list-control"><input type="checkbox" disabled checked/><span class="task-list-indicator"></span></label> encryption</li>
<li class="task-list-item"><label class="task-list-control"><input type="checkbox" disabled/><span class="task-list-indicator"></span></label> persistent disk protection</li>
<li class="task-list-item"><label class="task-list-control"><input type="checkbox" disabled checked/><span class="task-list-indicator"></span></label> separation of duties</li>
</ul>
<p>This lab covers the features that are checked in the list above.  (We won't rest on our laurels until we've built this lab out to cover everything under the sun, but, as the saying goes, <em>Rome wasn't built in a day</em>).</p>
<p>One of the things we just mentioned in the previous paragraph was <em>separation of duties</em>. In a real world situation, multiple personas could create different portions of the contract:</p>
<ul>
<li>an <em>application owner</em> deployer might create the <em>workload</em> section of the contract</li>
<li>a <em>systems administrator</em> might create the <em>environment</em> section of the contract</li>
</ul>
<p>Then, you could imagine the following scenario taking place:</p>
<ol>
<li>application owner can encrypt their piece of the contract such that it can only be decrypted within the HPVS 2.1.4 runtime</li>
<li>application owner passes their encrypted piece of the contract to the <em>systems administrator</em></li>
<li>the <em>systems administrator</em> encrypts their own section</li>
<li>the <em>systems administrator</em> combines the two sections and signs the resultant contract so that it can be verified by the HPVS 2.1.4 runtime.</li>
</ol>
<div class="admonition question">
<p class="admonition-title">Your inquiring mind may say, well that's all well and good, but what about the disk storage of the machine?</p>
<p>If your workload requires persistent disk storage (to survive a <abbr title="a running instance of an OCI image.">container</abbr> restart) then each of the two personas supplies part of a seed that is used in the calculation of an encryption key for the persistent disk. Neither persona has knowledge of the other's part of the seed if it is passed between parties encrypted, so that no human has the ability to decrypt the persistent disk.  The HPVS developers have thought through security very carefully! <img alt="ðŸ¤“" class="twemoji" src="https://cdn.jsdelivr.net/gh/jdecked/twemoji@14.1.2/assets/svg/1f913.svg" title=":nerd_face:" /> </p>
</div>
<p>Now this lab does not include all of the above features- for example, in this lab we are not using persistent disk storage.  And for this lab, you have and will continue to wear many hats, including both the <em>application owner</em> workload deployer and the <em>system administrator</em> environment deployer, performing many roles that in the "real world" are likely to be delegated to multiple individuals.  We are not going to cover <em>attestation</em> in this lab either, but hope to do so in a future lab.</p>
<h2 id="creation-of-directory-structure-for-contract">Creation of directory structure for contract<a class="headerlink" href="#creation-of-directory-structure-for-contract" title="Permanent link">&para;</a></h2>
<p>This section starts where the last section left off- on your session with the <abbr title="Red Hat Enterprise Linux">RHEL</abbr> host:</p>
<p><img src="../../../images/RHELHost.png" width="351" height="216" /></p>
<p>Switch to your home directory:</p>
<div class="highlight"><pre><span></span><code><span class="nb">cd</span><span class="w"> </span><span class="si">${</span><span class="nv">HOME</span><span class="si">}</span>
</code></pre></div>
<p>Create a directory structure for creating an HPVS 2.1.4 contract:</p>
<div class="highlight"><pre><span></span><code>mkdir<span class="w"> </span>-p<span class="w"> </span>contract/paynow/<span class="o">{</span>environment,workload/compose<span class="o">}</span>
</code></pre></div>
<p>Now see the directory structure you just created:</p>
<div class="highlight"><pre><span></span><code>tree<span class="w"> </span>contract
</code></pre></div>
<p>A contract requires a <em>workload</em> section and an <em>environment</em> section, and they each get their own directory. Then the sections are packaged together, and signed, and the signature is added as the third section.  This final result- the contract-  will be stored in your <code>${HOME}/contract/paynow</code> directory.</p>
<h2 id="create-workload-section-of-the-contract">Create workload section of the contract<a class="headerlink" href="#create-workload-section-of-the-contract" title="Permanent link">&para;</a></h2>
<p>Switch to your workload directory:</p>
<div class="highlight"><pre><span></span><code><span class="nb">cd</span><span class="w"> </span><span class="si">${</span><span class="nv">HOME</span><span class="si">}</span>/contract/paynow/workload
</code></pre></div>
<p>HPVS expects the contract to specify an <abbr title="Open Container Initiative: an open governance structure for the express purpose of creating open industry standards around container formats and runtimes. There are 3 specifications: the Runtime Specification (runtime-spec), the Image Specification (image-spec) and the Distribution Specification (distribution-spec)">OCI</abbr> <abbr title="a running instance of an OCI image.">container</abbr> specified by a <em><abbr title="a tool for defining and running multi-container Docker applications. With Compose, you use a YAML file to configure your applicationâ€™s services. Then, with a single command, you create and start all the services from your configuration.">Docker Compose</abbr></em> file.  The <em><abbr title="a tool for defining and running multi-container Docker applications. With Compose, you use a YAML file to configure your applicationâ€™s services. Then, with a single command, you create and start all the services from your configuration.">Docker Compose</abbr></em> file specifies an <abbr title="Open Container Initiative: an open governance structure for the express purpose of creating open industry standards around container formats and runtimes. There are 3 specifications: the Runtime Specification (runtime-spec), the Image Specification (image-spec) and the Distribution Specification (distribution-spec)">OCI</abbr> image to run and other information necessary to configure the resulting <abbr title="a running instance of an OCI image.">container</abbr>. Your workload is the PayNow Demo. You created an <abbr title="Open Container Initiative: an open governance structure for the express purpose of creating open industry standards around container formats and runtimes. There are 3 specifications: the Runtime Specification (runtime-spec), the Image Specification (image-spec) and the Distribution Specification (distribution-spec)">OCI</abbr> image for that on your <abbr title="this is a term we use to refer to a KVM guest that is not protected with Secure Execution for Linux">standard KVM guest</abbr> earlier in the lab.  In order to allow tyou to perform the lab without having to have an account at Docker or Quay.io or another image registry service, the instructors have created an <abbr title="Open Container Initiative: an open governance structure for the express purpose of creating open industry standards around container formats and runtimes. There are 3 specifications: the Runtime Specification (runtime-spec), the Image Specification (image-spec) and the Distribution Specification (distribution-spec)">OCI</abbr> image that is hosted in Quay.io and is used for this section of the lab.  This <abbr title="Open Container Initiative: an open governance structure for the express purpose of creating open industry standards around container formats and runtimes. There are 3 specifications: the Runtime Specification (runtime-spec), the Image Specification (image-spec) and the Distribution Specification (distribution-spec)">OCI</abbr> image was created in the exact same way you created the image on your <abbr title="this is a term we use to refer to a KVM guest that is not protected with Secure Execution for Linux">standard KVM guest</abbr>.  </p>
<h3 id="create-docker-compose-file">Create docker-compose file<a class="headerlink" href="#create-docker-compose-file" title="Permanent link">&para;</a></h3>
<p>Switch to the directory that will hold your <abbr title="a tool for defining and running multi-container Docker applications. With Compose, you use a YAML file to configure your applicationâ€™s services. Then, with a single command, you create and start all the services from your configuration.">Docker Compose</abbr> file:</p>
<div class="highlight"><pre><span></span><code><span class="nb">cd</span><span class="w"> </span>compose
</code></pre></div>
<p>Create the docker-compose file:</p>
<div class="highlight"><pre><span></span><code>cat<span class="w"> </span><span class="s">&lt;&lt; EOF &gt; docker-compose.yml</span>
<span class="s">version: &#39;3&#39;</span>
<span class="s">services:</span>
<span class="s">  paynow:</span>
<span class="s">    image: quay.io/bsilliman/paynow@sha256:b0921f4009b33b926aeae931fef2b0536514e7a62ae013cee6c345b1ac7f11bb</span>
<span class="s">    ports:</span>
<span class="s">      - &quot;8443:8443&quot;</span>
<span class="s">EOF</span>
</code></pre></div>
<p>Notice the value of the <em>image</em> key.  This is the PayNow Demo image created by the instructor and hosted on Red Hat's Quay.io registry service. </p>
<h3 id="add-a-convenience-script-to-create-the-workload-section">Add a convenience script to create the workload section<a class="headerlink" href="#add-a-convenience-script-to-create-the-workload-section" title="Permanent link">&para;</a></h3>
<p>You are almost finished with the workload section.  One thing to do is to add a convenience script to the workload directory.  This script is not
supplied with the product, but is very useful in the creation of the contract.  Create it now and feel free to peruse it but do not run it now.
It will be called later by another script.  Comments have been added to help explain what the script does. </p>
<p>Switch directories:</p>
<div class="highlight"><pre><span></span><code><span class="nb">cd</span><span class="w"> </span><span class="si">${</span><span class="nv">HOME</span><span class="si">}</span>/contract/paynow/workload/
</code></pre></div>
<p>Create the convenience script:</p>
<div class="highlight"><pre><span></span><code><span class="l l-Scalar l-Scalar-Plain">cat &lt;&lt;-EOF &gt; flow.workload</span>
<span class="l l-Scalar l-Scalar-Plain"># Create the workload section of the contract and add the contents in the workload.yaml file.</span>

<span class="l l-Scalar l-Scalar-Plain">#</span><span class="w"> </span>
<span class="l l-Scalar l-Scalar-Plain"># The Docker Compose file and all supporting configuration files are assumed to be in the ./compose directory</span>
<span class="l l-Scalar l-Scalar-Plain"># There should not be any unnecessary files as they will get tarred up and added to the COMPOSE_B64 variable</span>
<span class="l l-Scalar l-Scalar-Plain">#</span>
<span class="l l-Scalar l-Scalar-Plain">COMPOSE_B64=\$(tar -czv -C compose . | base64 -w0)</span>

<span class="l l-Scalar l-Scalar-Plain">#</span>
<span class="l l-Scalar l-Scalar-Plain"># This specifies an intermediate file that could be deleted at the end of the script but</span><span class="w"> </span>
<span class="l l-Scalar l-Scalar-Plain"># is left intact for lab learning purposes-  it is plaintext so keeping it implies that</span>
<span class="l l-Scalar l-Scalar-Plain"># you would have to protect it appropriately.  In production you&#39;ll probably want to delete it</span>
<span class="l l-Scalar l-Scalar-Plain">#</span>
<span class="l l-Scalar l-Scalar-Plain">WORKLOAD_PLAIN=./workload.yaml.plaintext</span>

<span class="l l-Scalar l-Scalar-Plain">#</span>
<span class="l l-Scalar l-Scalar-Plain"># This specifies a file will be encrypted and signed and is the primary output of this script.</span><span class="w">  </span>
<span class="l l-Scalar l-Scalar-Plain"># It is combined with the encrypted and signed environment section that is created by</span><span class="w"> </span>
<span class="l l-Scalar l-Scalar-Plain"># another script (flow.signature which is one directory level higher)</span>
<span class="l l-Scalar l-Scalar-Plain"># Note</span><span class="p p-Indicator">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">this file will also wind up one directory level higher</span>
<span class="c1">#</span>
<span class="l l-Scalar l-Scalar-Plain">WORKLOAD=workload.yaml</span>

<span class="l l-Scalar l-Scalar-Plain">echo &quot;  type</span><span class="p p-Indicator">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">workload</span>
<span class="w">  </span><span class="l l-Scalar l-Scalar-Plain">compose</span><span class="p p-Indicator">:</span>
<span class="w">    </span><span class="nt">archive</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">\${COMPOSE_B64}&quot; &gt; \${WORKLOAD_PLAIN}</span>

<span class="c1">#</span>
<span class="c1"># This is the encryption certificate for Hyper Protect Container Runtime and it is</span>
<span class="c1"># provided with the Hyper Protect Virtual Servers v2.1.4 product</span>
<span class="c1">#</span>
<span class="l l-Scalar l-Scalar-Plain">CONTRACT_KEY=/data/lab/hpvs214Certs/ibm-hyper-protect-container-runtime-23.3.0-encrypt.crt</span>

<span class="c1">#</span>
<span class="c1"># This variable holds a random password:</span>
<span class="c1">#</span>
<span class="l l-Scalar l-Scalar-Plain">PASSWORD_WORKLOAD=&quot;\$(openssl rand 32 | base64 -w0)&quot;</span>

<span class="c1">#</span>
<span class="c1"># This variable holds the output of the command pipe that</span>
<span class="c1"># takes your plaintext workload yaml ($WORKLOAD_PLAIN) and encrypts it using the password that </span>
<span class="c1"># was generated above ($PASSWORD_WORKLOAD) and then base64 encodes this encrypted workload</span>
<span class="c1">#</span>
<span class="c1"># As long as nobody else knows your random password ($PASSWORD_WORKLOAD) your data is safe.  </span>
<span class="c1"># But, the Hyper Protect Container Runtime has to encrypt it, so it needs your password. </span>
<span class="c1"># How will it get that password securely?  Read the next set of comment lines to find out.</span>
<span class="c1">#</span>
<span class="l l-Scalar l-Scalar-Plain">ENCRYPTED_WORKLOAD=&quot;\$(echo -n &quot;\$PASSWORD_WORKLOAD&quot; | base64 -d | openssl enc -aes-256-cbc -pbkdf2 -pass stdin -in &quot;\$WORKLOAD_PLAIN&quot; | base64 -w0)&quot;</span>

<span class="c1">#</span>
<span class="c1"># This variable provides secure passage of your random password.  How?  </span>
<span class="c1"># It encrypts it with the encryption key of the Hyper Protect Container Runtime (HPCR).</span>
<span class="c1"># (A key that is encrypted by another key is often called a wrapped key).</span>
<span class="c1"># Only the HPCR image has the private key which can decrypt this. It is protected from </span>
<span class="c1"># access from any administrators.  So, malicious actors cannot do anything with this</span>
<span class="c1"># wrapped key, even if they were able to get a hold of it.</span>
<span class="c1"># </span>
<span class="c1">#</span>
<span class="l l-Scalar l-Scalar-Plain">ENCRYPTED_WORKLOAD_PASSWORD=&quot;\$(echo -n &quot;\$PASSWORD_WORKLOAD&quot; | base64 -d | openssl rsautl -encrypt -inkey \$CONTRACT_KEY -certin | base64 -w0 )&quot;</span>

<span class="c1">#</span>
<span class="c1"># Use the following command to get the encrypted section of the contract:</span>
<span class="c1"># This variable holds the output of a concatenation of a header, &quot;hyper-protect-basic&quot;,</span>
<span class="c1"># Your wrapped key, and your encrypted workload. </span>
<span class="c1">#</span>
<span class="l l-Scalar l-Scalar-Plain">WORKLOAD_ENCRYPTED=&quot;hyper-protect-basic.\${ENCRYPTED_WORKLOAD_PASSWORD}.\${ENCRYPTED_WORKLOAD}&quot;</span>

<span class="c1">#</span>
<span class="c1"># The above variable is echoed to the a file the directory one level above</span>
<span class="c1">#</span>
<span class="l l-Scalar l-Scalar-Plain">echo &quot;\$WORKLOAD_ENCRYPTED&quot; &gt; ../\$WORKLOAD</span>

<span class="c1"># </span>
<span class="c1"># NOTE: In a production scenario the plaintext workload section would be </span>
<span class="c1"># deleted or stored securely but it has been left here for student perusal.  </span>
<span class="c1"># The filename is workload.yaml.plaintext</span>
<span class="c1">#</span>
<span class="l l-Scalar l-Scalar-Plain">EOF</span>
</code></pre></div>
<h2 id="create-environment-section-of-the-contract">Create environment section of the contract<a class="headerlink" href="#create-environment-section-of-the-contract" title="Permanent link">&para;</a></h2>
<ol>
<li>
<p>Change to the directory where you will prepare for environment section of the contract:</p>
<div class="highlight"><pre><span></span><code><span class="nb">cd</span><span class="w"> </span>../environment
</code></pre></div>
</li>
<li>
<p>In the environment section of the contract you are going to specify the information in 
order to have your HPVS KVM Guest log to the <abbr title="rsyslog is a system utility providing support for message logging.  Support of both internet and unix domain sockets enables this utility to support both local and remote logging">rsyslog</abbr> service that you configured earlier in the lab.</p>
<ol>
<li>
<p>Create a directory to gather some files you will need for this <abbr title="rsyslog is a system utility providing support for message logging.  Support of both internet and unix domain sockets enables this utility to support both local and remote logging">rsyslog</abbr> configuration and change to it:</p>
<div class="highlight"><pre><span></span><code>mkdir<span class="w"> </span>-p<span class="w"> </span>rsyslog<span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nb">cd</span><span class="w"> </span>rsyslog
</code></pre></div>
</li>
<li>
<p>You will need the <abbr title="certification authority">CA</abbr> certificate of the <abbr title="rsyslog is a system utility providing support for message logging.  Support of both internet and unix domain sockets enables this utility to support both local and remote logging">rsyslog</abbr> service that you created on your Ubuntu KVM guest which you can get via <em>scp</em>:</p>
<div class="highlight"><pre><span></span><code>scp<span class="w"> </span>student@<span class="si">${</span><span class="nv">StudentGuestIP</span><span class="si">}</span>:rsyslogWork/ca.crt<span class="w"> </span>.
</code></pre></div>
</li>
<li>
<p>Copy your <abbr title="rsyslog is a system utility providing support for message logging.  Support of both internet and unix domain sockets enables this utility to support both local and remote logging">rsyslog</abbr> client certificate from your working directory:</p>
<div class="highlight"><pre><span></span><code>cp<span class="w"> </span>-ipv<span class="w"> </span><span class="si">${</span><span class="nv">HOME</span><span class="si">}</span>/rsyslogClientWork/client.crt<span class="w"> </span>.
</code></pre></div>
</li>
<li>
<p>Convert the client certificate to PKCS#8 format</p>
<p>The directory you just copied the client certificate from also has your private key that you need. However, the <abbr title="Hyper Protect Container Runtime- this is the name given to the Secure Execution-enabled qcow2 image that is provided with Hyper Protect Virtual Servers 2.1.x. The container runtime provided within this image launches the customer's workload as an OCI container, in accordance with the &quot;contract&quot; specified by the customer.">HPCR</abbr> image requires this to be in PKCS#8  (Public Key Cryptography Standard #8) format. Therefore you can't just copy it over- you need to convert it to PKCS#8 format:</p>
<div class="highlight"><pre><span></span><code>openssl<span class="w"> </span>pkcs8<span class="w"> </span>-topk8<span class="w"> </span>-inform<span class="w"> </span>PEM<span class="w"> </span>-outform<span class="w"> </span>PEM<span class="w"> </span>-nocrypt<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>-in<span class="w"> </span><span class="si">${</span><span class="nv">HOME</span><span class="si">}</span>/rsyslogClientWork/client-key.pem<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>-out<span class="w"> </span>client-key-pkcs8.pem
</code></pre></div>
</li>
<li>
<p>Go back up one directory level:</p>
<div class="highlight"><pre><span></span><code><span class="nb">cd</span><span class="w"> </span>..<span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nb">pwd</span>
</code></pre></div>
</li>
<li>
<p>We have provided a convenience script to assist in creating the environment section of the contract</p>
<p>This script is not supplied with the product, but is very useful in the creation of the contract. Create it now and feel free to peruse it but do not run it now. It will be called later by another script. Comments have been added to help explain what the script does. </p>
<div class="highlight"><pre><span></span><code><span class="l l-Scalar l-Scalar-Plain">cat &lt;&lt;-EOF &gt; flow.env</span>
<span class="l l-Scalar l-Scalar-Plain"># Create the env section of the contract and add the contents in the env.yaml file.</span>

<span class="l l-Scalar l-Scalar-Plain">#</span>
<span class="l l-Scalar l-Scalar-Plain"># set some file locations at the top of the file here</span>
<span class="l l-Scalar l-Scalar-Plain">#</span>
<span class="l l-Scalar l-Scalar-Plain">RSYSLOG_CA_CRT=&quot;./rsyslog/ca.crt&quot;</span>
<span class="l l-Scalar l-Scalar-Plain">RSYSLOG_CLIENT_CRT=&quot;./rsyslog/client.crt&quot;</span>
<span class="l l-Scalar l-Scalar-Plain">RSYSLOG_CLIENT_KEY=&quot;./rsyslog/client-key-pkcs8.pem&quot;</span>

<span class="l l-Scalar l-Scalar-Plain">#</span>
<span class="l l-Scalar l-Scalar-Plain"># This specifies an intermediate file that could be deleted at the end of the script but</span><span class="w"> </span>
<span class="l l-Scalar l-Scalar-Plain"># is left intact for lab learning purposes-  it is plaintext so keeping it implies that</span>
<span class="l l-Scalar l-Scalar-Plain"># you would have to protect it appropriately.  In production you&#39;ll probably want to delete it</span>
<span class="l l-Scalar l-Scalar-Plain">#</span>
<span class="l l-Scalar l-Scalar-Plain">ENV_PLAIN=&quot;./env.yaml.plaintext&quot;</span>

<span class="l l-Scalar l-Scalar-Plain">#</span>
<span class="l l-Scalar l-Scalar-Plain"># This specifies a file will be encrypted and signed and is the primary output of this script.</span><span class="w">  </span>
<span class="l l-Scalar l-Scalar-Plain"># It is combined with the encrypted and signed workload section that is created by</span><span class="w"> </span>
<span class="l l-Scalar l-Scalar-Plain"># another script (flow.signature which is one directory level higher)</span>
<span class="l l-Scalar l-Scalar-Plain"># Note</span><span class="p p-Indicator">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">this file will also wind up one directory level higher</span>
<span class="c1">#</span>
<span class="l l-Scalar l-Scalar-Plain">ENV=&quot;env.yaml&quot;</span>

<span class="c1">#</span>
<span class="c1"># This variable holds the output of taking all the newlines out of the rsyslog CA certificate and</span>
<span class="c1"># replacing them with the &quot;\n&quot; characters.  In other words, a multiple line file is squashed down </span>
<span class="c1"># to one line.  The HPCR runtime image will then convert it back to the multiple line format</span>
<span class="c1">#</span>
<span class="l l-Scalar l-Scalar-Plain">ENV_RSYSLOG_SERVER=\$(awk -vRS=&quot;\n&quot; -vORS=&quot;\\\\\n&quot; &#39;1&#39; \${RSYSLOG_CA_CRT})</span>

<span class="c1">#</span>
<span class="c1"># This variable holds the output of taking all the newlines out of the client certificate that the</span>
<span class="c1"># HPCR runtime uses for communicating with rsyslog and replacing them with the &quot;\n&quot; characters.</span>
<span class="c1"># In other words, a multiple line file is squashed down to one line. THe HPCR runtime image will </span>
<span class="c1"># then convert it back to the multiple line format</span>
<span class="c1">#</span>
<span class="l l-Scalar l-Scalar-Plain">ENV_RSYSLOG_CERT=\$(awk -vRS=&quot;\n&quot; -vORS=&quot;\\\\\n&quot; &#39;1&#39; \${RSYSLOG_CLIENT_CRT})</span>

<span class="c1">#</span>
<span class="c1"># This variable holds the output of taking all the newlines out of the client private key that the</span>
<span class="c1"># HPCR runtime uses for communicating with rsyslog and replacing them with the &quot;\n&quot; characters.</span>
<span class="c1"># In other words, a multiple line file is squashed down to one line. THe HPCR runtime image will </span>
<span class="c1"># then convert it back to the multiple line format. Before this all happens, the Private Key is </span>
<span class="c1"># converted to PKCS#8 format</span>
<span class="c1">#</span>
<span class="l l-Scalar l-Scalar-Plain">ENV_RSYSLOG_KEY=\$(awk -vRS=&quot;\n&quot; -vORS=&quot;\\\\\n&quot; &#39;1&#39;  \${RSYSLOG_CLIENT_KEY})</span>


<span class="l l-Scalar l-Scalar-Plain">echo &quot;  type</span><span class="p p-Indicator">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">env</span>
<span class="w">  </span><span class="l l-Scalar l-Scalar-Plain">logging</span><span class="p p-Indicator">:</span>
<span class="w">    </span><span class="nt">syslog</span><span class="p">:</span>
<span class="w">      </span><span class="nt">hostname</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">\&quot;\${StudentGuestIP}\&quot;</span>
<span class="w">      </span><span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">6514</span>
<span class="w">      </span><span class="nt">server</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">\&quot;\${ENV_RSYSLOG_SERVER}\&quot;</span>
<span class="w">      </span><span class="nt">cert</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">\&quot;\${ENV_RSYSLOG_CERT}\&quot;</span>
<span class="w">      </span><span class="nt">key</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">\&quot;\${ENV_RSYSLOG_KEY}\&quot;&quot; &gt;\${ENV_PLAIN}</span>

<span class="c1">#</span>
<span class="c1"># This command adds the public signing key to the plaintext environment yaml.  This key is used inside </span>
<span class="c1"># the Hyper Protect Container Runtime image to verify the signature over workload and environment sections of</span>
<span class="c1"># the contract. </span>
<span class="c1">#</span>
<span class="l l-Scalar l-Scalar-Plain">cat ./pubSigningKey.yaml &gt;&gt; \${ENV_PLAIN}</span>

<span class="c1"># This is the encryption certificate for Hyper Protect Container Runtime and it is</span>
<span class="c1"># provided with the Hyper Protect Virtual Servers v2.1.4 product</span>
<span class="c1">#</span>
<span class="l l-Scalar l-Scalar-Plain">CONTRACT_KEY=/data/lab/hpvs214Certs/ibm-hyper-protect-container-runtime-23.3.0-encrypt.crt</span>

<span class="c1">#</span>
<span class="c1"># This variable holds a random password:</span>
<span class="c1">#</span>
<span class="l l-Scalar l-Scalar-Plain">PASSWORD_ENV=&quot;\$(openssl rand 32 | base64 -w0)&quot;</span>

<span class="c1">#</span>
<span class="c1"># This variable holds the output of the command pipe that</span>
<span class="c1"># takes your plaintext environment yaml (\$ENV_PLAIN) and encrypts it using the password that </span>
<span class="c1"># was generated above (\$PASSWORD_ENV) and then base64 encodes this encrypted environment yaml</span>
<span class="c1">#</span>
<span class="c1"># As long as nobody else knows your random password (\$PASSWORD_ENV) your data is safe.  </span>
<span class="c1"># But, the Hyper Protect Container Runtime has to encrypt it, so it needs your password. </span>
<span class="c1"># How will it get that password securely?  Read the next set of comment lines to find out.</span>
<span class="c1">#</span>
<span class="l l-Scalar l-Scalar-Plain">ENCRYPTED_ENV=&quot;\$(echo -n &quot;\$PASSWORD_ENV&quot; | base64 -d | openssl enc -aes-256-cbc -pbkdf2 -pass stdin -in &quot;\$ENV_PLAIN&quot; | base64 -w0)&quot;</span>

<span class="c1">#</span>
<span class="c1"># This variable provides secure passage for your random password.  How?  </span>
<span class="c1"># It encrypts it with the encryption key of the Hyper Protect Container Runtime (HPCR).</span>
<span class="c1"># (A key that is encrypted by another key is often called a wrapped key).</span>
<span class="c1"># Only the HPCR image has the private key which can decrypt this. It is protected from </span>
<span class="c1"># access from any administrators.  So, malicious actors cannot do anything with this</span>
<span class="c1"># wrapped key, even if they were able to get a hold of it.</span>
<span class="c1">#</span>
<span class="l l-Scalar l-Scalar-Plain">ENCRYPTED_ENV_PASSWORD=&quot;\$(echo -n &quot;\$PASSWORD_ENV&quot; | base64 -d | openssl rsautl -encrypt -inkey \$CONTRACT_KEY -certin | base64 -w0 )&quot;</span>

<span class="c1">#</span>
<span class="c1"># Use the following command to get the encrypted environment section of the contract:</span>
<span class="c1"># This variable holds the output of a concatenation of a header, &quot;hyper-protect-basic&quot;,</span>
<span class="c1"># Your wrapped key, and your encrypted environment yaml.. </span>
<span class="c1">#</span>
<span class="l l-Scalar l-Scalar-Plain">ENV_ENCRYPTED=&quot;hyper-protect-basic.\${ENCRYPTED_ENV_PASSWORD}.\${ENCRYPTED_ENV}&quot;</span>
<span class="c1">#</span>
<span class="c1"># The above variable writes the encrypted environment section to the directory one level above</span>
<span class="c1">#</span>
<span class="l l-Scalar l-Scalar-Plain">echo &quot;\$ENV_ENCRYPTED&quot; &gt; ../\$ENV</span>
<span class="l l-Scalar l-Scalar-Plain">EOF</span>
</code></pre></div>
</li>
</ol>
</li>
<li>
<p>Backup one more directory level:</p>
<div class="highlight"><pre><span></span><code><span class="nb">cd</span><span class="w"> </span>..
</code></pre></div>
</li>
<li>
<p>You will create three more files that are convenience scripts, similar to <em>flow.workload</em> and <em>flow.env</em> which you have already created:</p>
<ol>
<li>
<p>The first script will provide some preparation steps.  Create it, peruse it, love it, but don't run it yet:</p>
<div class="highlight"><pre><span></span><code>cat<span class="w"> </span><span class="s">&lt;&lt; EOF &gt; flow.prepare</span>

<span class="s"># Use the following command to generate a key pair to sign the contract </span>
<span class="s">openssl genrsa -aes128 -passout pass:test1234 -out private.pem 4096</span>
<span class="s">openssl rsa -in private.pem -passin pass:test1234 -pubout -out public.pem</span>

<span class="s"># The following command is an example of how you can get the signing key:</span>
<span class="s">key=\$(awk -vRS=&quot;\n&quot; -vORS=&quot;\\\\\n&quot; &#39;1&#39; public.pem)</span>
<span class="s">echo &quot;  signingKey: \&quot;\${key%\\\\n}\&quot;&quot; &gt; environment/pubSigningKey.yaml</span>
<span class="s">EOF</span>
</code></pre></div>
</li>
<li>
<p>Create the second script which signs the concatenated workload and environment sections of the contract and then appends the signature as the third and final element of the contract.  Don't run it yet!</p>
<div class="highlight"><pre><span></span><code>cat<span class="w"> </span><span class="s">&lt;&lt; EOF &gt; flow.signature</span>
<span class="s"># combine workload and environment</span>
<span class="s">cat workload.yaml env.yaml | tr -d &#39;\n&#39; &gt; contract.yaml</span>

<span class="s"># Sign the combination from workload and env being approved</span>
<span class="s">echo \$( cat contract.yaml | openssl dgst -sha256 -sign private.pem | openssl enc -base64) | tr -d &#39; &#39; &gt; signature.yaml</span>

<span class="s"># Create user data and add signature:</span>
<span class="s">echo &quot;workload: \$(cat workload.yaml)</span>
<span class="s">env: \$(cat env.yaml)</span>
<span class="s">envWorkloadSignature: \$(cat signature.yaml)&quot; &gt; user_data.yaml</span>

<span class="s">echo &quot;&quot;</span>
<span class="s">echo &quot;import \`pwd\`/user_data.yaml into User Data or copy and paste from below:&quot;</span>
<span class="s">echo &quot;&quot;</span>

<span class="s">cat user_data.yaml</span>
<span class="s">EOF</span>
</code></pre></div>
</li>
<li>
<p>This script isn't strictly necessary for the lab for reasons stated in the comments in the script, but you can create it anyway:</p>
<div class="highlight"><pre><span></span><code>cat<span class="w"> </span><span class="s">&lt;&lt; EOF &gt; flow.clear</span>
<span class="s">#</span>
<span class="s"># It isn&#39;t really necessary to run this in our lab environment </span>
<span class="s"># because the other scripts will happily trod on these files </span>
<span class="s"># as necessary.</span>
<span class="s">#</span>
<span class="s"># It is more likely that you would run this after running the</span>
<span class="s"># other scripts in order to remove these files for security</span>
<span class="s"># reasons</span>
<span class="s">#</span>
<span class="s"># But if you ever had a need to save your signing key pair, </span>
<span class="s"># you would want to save private.pem somewhere safe.</span>
<span class="s"># </span>
<span class="s">rm private.pem public.pem</span>
<span class="s">rm environment/pubSigningKey.yaml environment/env.yaml.plaintext</span>
<span class="s">rm workload/workload.yaml.plaintext</span>
<span class="s">rm env.yaml workload.yaml contract.yaml signature.yaml user_data.yaml</span>
<span class="s">EOF</span>
</code></pre></div>
</li>
</ol>
</li>
</ol>
<h2 id="encrypt-and-sign-the-contract">Encrypt and sign the contract<a class="headerlink" href="#encrypt-and-sign-the-contract" title="Permanent link">&para;</a></h2>
<ol>
<li>
<p>Create a final helper script which calls the <em>flow.*</em> scripts you created earlier:</p>
<div class="highlight"><pre><span></span><code>cat<span class="w"> </span><span class="s">&lt;&lt; EOF &gt; makeContract</span>
<span class="s">. ./flow.prepare</span>
<span class="s">cd workload</span>
<span class="s">. ./flow.workload</span>
<span class="s">cd ../environment</span>
<span class="s">. ./flow.env</span>
<span class="s">cd ..</span>
<span class="s">. ./flow.signature</span>

<span class="s">EOF</span>
</code></pre></div>
</li>
<li>
<p>Now run the helper script that you just created:</p>
<div class="highlight"><pre><span></span><code>.<span class="w"> </span>./makeContract
</code></pre></div>
</li>
</ol>
<p>You will be prompted to enter a passphrase.  In real life this is something that you would set yourself and have to keep track of.  For this lab, the script has hard-coded <code>test1234</code> so you must type that in and press enter when prompted for it.</p>
<p>The script creates the final contract in a file named <code>user_data.yaml</code>.  It also displays the contents of this file to the screen. At the bottom of the output you will see an <em>envWorkloadSignature</em> key.  If there is a gobbledygook value (base64-encoded text) associated with this key then things went well.</p>
<h2 id="create-the-startup-file-for-the-hpvs-kvm-guest">Create the startup file for the HPVS KVM guest<a class="headerlink" href="#create-the-startup-file-for-the-hpvs-kvm-guest" title="Permanent link">&para;</a></h2>
<ol>
<li>
<p>Create a copy of the <code>user_data.yaml</code> file that your created</p>
<p>The contract that you just created is going to be packaged with some other files into a startup file for your HPVS KVM guest that will run the PayNow demo. One of the files expected is a file named <code>user-data</code> that is just a copy of the <code>user_data.yaml</code> file that was just created</p>
<div class="highlight"><pre><span></span><code>cp<span class="w"> </span>-ipv<span class="w"> </span>user_data.yaml<span class="w"> </span>user-data
</code></pre></div>
<div class="admonition info">
<p class="admonition-title">Why didn't the script just do the above copy for me</p>
<p>We kept <em>user-data</em> intact in case something went wrong in the process, in which case <em>user_data.yaml</em> may be rubbish but at least you haven't trampled on a good <em>user-data</em> that might already be in use.  </p>
</div>
</li>
<li>
<p>Create <code>vendor-data</code> which is another file required by the process:</p>
<div class="highlight"><pre><span></span><code>cat<span class="w"> </span><span class="s">&lt;&lt; EOF &gt; vendor-data</span>
<span class="s">#cloud-config</span>
<span class="s">users:</span>
<span class="s">- default</span>
<span class="s">EOF</span>
</code></pre></div>
</li>
<li>
<p>Create <code>meta-data</code> which is also required, and it will have a hostname tailored for your userid:</p>
<div class="highlight"><pre><span></span><code>cat<span class="w"> </span><span class="s">&lt;&lt; EOF &gt; meta-data</span>
<span class="s">local-hostname: $(whoami)-paynowdemo</span>
<span class="s">EOF</span>
</code></pre></div>
</li>
<li>
<p>Run this command (<abbr title="Red Hat Enterprise Linux">RHEL</abbr>-specific, see product documentation for Ubuntu command) in order to create the startup file, <em>ciiso.iso</em>:</p>
<div class="highlight"><pre><span></span><code>genisoimage<span class="w"> </span>-output<span class="w"> </span>/var/lib/libvirt/images/labs/paynow/<span class="k">$(</span>whoami<span class="k">)</span>/ciiso.iso<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>-volid<span class="w"> </span>cidata<span class="w"> </span>-joliet<span class="w"> </span>-rock<span class="w"> </span>user-data<span class="w"> </span>meta-data<span class="w"> </span>vendor-data
</code></pre></div>
<p>Your output will look like this:</p>
<details class="- example">
<summary>Output from genisoimage command</summary>
<div class="highlight"><pre><span></span><code>I: -input-charset not specified, using utf-8 (detected in locale settings)
Total translation table size: 0
Total rockridge attributes bytes: 414
Total directory bytes: 0
Path table size(bytes): 10
Max brk space used 0
203 extents written (0 MB)
</code></pre></div>
</details>
</li>
</ol>
<p>Please click the <em>Next</em> link at the bottom of the page to continue with the lab.</p>

  <hr>
<div class="md-source-file">
  <small>
    
      Last update:
      <span class="git-revision-date-localized-plugin git-revision-date-localized-plugin-date">April 25, 2023</span>
      
        <br>
        Created:
        <span class="git-revision-date-localized-plugin git-revision-date-localized-plugin-date">April 25, 2023</span>
      
    
  </small>
</div>


  



  <form class="md-feedback" name="feedback" hidden>
    <fieldset>
      <legend class="md-feedback__title">
        Was this page helpful?
      </legend>
      <div class="md-feedback__inner">
        <div class="md-feedback__list">
          
            <button class="md-feedback__icon md-icon" type="submit" title="This page was helpful" data-md-value="1">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="m12 21.35-1.45-1.32C5.4 15.36 2 12.27 2 8.5 2 5.41 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.08C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.41 22 8.5c0 3.77-3.4 6.86-8.55 11.53L12 21.35Z"/></svg>
            </button>
          
            <button class="md-feedback__icon md-icon" type="submit" title="This page could be improved" data-md-value="0">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="m12 21.35-1.45-1.32C5.4 15.36 2 12.27 2 8.5 2 5.41 4.42 3 7.5 3c.67 0 1.32.12 1.94.33L13 9.35l-4 5 3 7M16.5 3C19.58 3 22 5.41 22 8.5c0 3.77-3.4 6.86-8.55 11.53L12 21.35l-1-7 4.5-5-2.65-5.08C13.87 3.47 15.17 3 16.5 3Z"/></svg>
            </button>
          
        </div>
        <div class="md-feedback__note">
          
            <div data-md-value="1" hidden>
              
              
                
              
              Thanks for your feedback!
            </div>
          
            <div data-md-value="0" hidden>
              
              
                
              
              Thanks for your feedback! Help us improve this page by using our <a href="https://github.com/ibm-wsc/ConfidentialComputingOnLinuxONE/issues/new/?title=[Feedback]+Create%20contract%20for%20HPVS%20guest+-+/lab/paynow/createContract/" target="_blank" rel="noopener">feedback form</a>.
            </div>
          
        </div>
      </div>
    </fieldset>
  </form>


                
              </article>
            </div>
          
          
  <script>var tabs=__md_get("__tabs");if(Array.isArray(tabs))e:for(var set of document.querySelectorAll(".tabbed-set")){var tab,labels=set.querySelector(".tabbed-labels");for(tab of tabs)for(var label of labels.getElementsByTagName("label"))if(label.innerText.trim()===tab){var input=document.getElementById(label.htmlFor);input.checked=!0;continue e}}</script>

        </div>
        
          <button type="button" class="md-top md-icon" data-md-component="top" hidden>
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12Z"/></svg>
            Back to top
          </button>
        
      </main>
      
        <footer class="md-footer">
  
    
      
      <nav class="md-footer__inner md-grid" aria-label="Footer" >
        
          
          <a href="../configureRsyslogForHPVS/" class="md-footer__link md-footer__link--prev" aria-label="Previous: Configure rsyslog client certs on the RHEL host" rel="prev">
            <div class="md-footer__button md-icon">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
            </div>
            <div class="md-footer__title">
              <span class="md-footer__direction">
                Previous
              </span>
              <div class="md-ellipsis">
                Configure rsyslog client certs on the RHEL host
              </div>
            </div>
          </a>
        
        
          
          <a href="../launchHPVSguest/" class="md-footer__link md-footer__link--next" aria-label="Next: Launch HPVS guest for PayNow" rel="next">
            <div class="md-footer__title">
              <span class="md-footer__direction">
                Next
              </span>
              <div class="md-ellipsis">
                Launch HPVS guest for PayNow
              </div>
            </div>
            <div class="md-footer__button md-icon">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4Z"/></svg>
            </div>
          </a>
        
      </nav>
    
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
    <div class="md-copyright__highlight">
      Copyright &copy; 2022 IBM â€“ <a href="#__consent">Change cookie settings</a>

    </div>
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
        <div class="md-social">
  
    
    
    
    
      
      
    
    <a href="https://github.com/ibm-wsc" target="_blank" rel="noopener" title="github.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><!--! Font Awesome Free 6.4.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg>
    </a>
  
    
    
    
    
      
      
    
    <a href="https://hub.docker.com/u/s390x" target="_blank" rel="noopener" title="hub.docker.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 512"><!--! Font Awesome Free 6.4.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M349.9 236.3h-66.1v-59.4h66.1v59.4zm0-204.3h-66.1v60.7h66.1V32zm78.2 144.8H362v59.4h66.1v-59.4zm-156.3-72.1h-66.1v60.1h66.1v-60.1zm78.1 0h-66.1v60.1h66.1v-60.1zm276.8 100c-14.4-9.7-47.6-13.2-73.1-8.4-3.3-24-16.7-44.9-41.1-63.7l-14-9.3-9.3 14c-18.4 27.8-23.4 73.6-3.7 103.8-8.7 4.7-25.8 11.1-48.4 10.7H2.4c-8.7 50.8 5.8 116.8 44 162.1 37.1 43.9 92.7 66.2 165.4 66.2 157.4 0 273.9-72.5 328.4-204.2 21.4.4 67.6.1 91.3-45.2 1.5-2.5 6.6-13.2 8.5-17.1l-13.3-8.9zm-511.1-27.9h-66v59.4h66.1v-59.4zm78.1 0h-66.1v59.4h66.1v-59.4zm78.1 0h-66.1v59.4h66.1v-59.4zm-78.1-72.1h-66.1v60.1h66.1v-60.1z"/></svg>
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
      <div class="md-consent" data-md-component="consent" id="__consent" hidden>
        <div class="md-consent__overlay"></div>
        <aside class="md-consent__inner">
          <form class="md-consent__form md-grid md-typeset" name="consent">
            

  
    
  


  
    
  



  


<h4>Cookie consent</h4>
<p>We use cookies to recognize your repeated visits and preferences, as well as to measure the effectiveness of our documentation and whether users find what they're searching for. With your consent, you're helping us to make the documentation as good as possible.</p>
<input class="md-toggle" type="checkbox" id="__settings" >
<div class="md-consent__settings">
  <ul class="task-list">
    
      
      
        
        
      
      <li class="task-list-item">
        <label class="task-list-control">
          <input type="checkbox" name="analytics" checked>
          <span class="task-list-indicator"></span>
          Google Analytics
        </label>
      </li>
    
      
      
        
        
      
      <li class="task-list-item">
        <label class="task-list-control">
          <input type="checkbox" name="github" checked>
          <span class="task-list-indicator"></span>
          GitHub
        </label>
      </li>
    
  </ul>
</div>
<div class="md-consent__controls">
  
    
      <button class="md-button md-button--primary">Accept</button>
    
    
    
  
    
    
    
      <label class="md-button" for="__settings">Manage settings</label>
    
  
</div>
          </form>
        </aside>
      </div>
      <script>var consent=__md_get("__consent");if(consent)for(var input of document.forms.consent.elements)input.name&&(input.checked=consent[input.name]||!1);else"file:"!==location.protocol&&setTimeout(function(){document.querySelector("[data-md-component=consent]").hidden=!1},250);var action,form=document.forms.consent;for(action of["submit","reset"])form.addEventListener(action,function(e){if(e.preventDefault(),"reset"===e.type)for(var n of document.forms.consent.elements)n.name&&(n.checked=!1);__md_set("__consent",Object.fromEntries(Array.from(new FormData(form).keys()).map(function(e){return[e,!0]}))),location.hash="",location.reload()})</script>
    
    <script id="__config" type="application/json">{"base": "../../..", "features": ["header.autohide", "navigation.sections", "navigation.expand", "navigation.top", "navigation.tabs", "navigation.tabs.sticky", "navigation.tracking", "navigation.footer", "search.share", "navigation.indexes", "announce.dismiss", "content.tabs.link", "content.code.copy", "content.action.edit", "content.action.view"], "search": "../../../assets/javascripts/workers/search.208ed371.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script>
    
    
      <script src="../../../assets/javascripts/bundle.fac441b0.min.js"></script>
      
        <script src="../../../js/print-site.js"></script>
      
    
  </body>
</html>